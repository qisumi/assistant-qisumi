# 后端开发 TODO 列表

## 1. 目录结构创建
- [ ] 创建完整的目录结构
  - [ ] cmd/server/main.go
  - [ ] internal/config/
  - [ ] internal/db/
  - [ ] internal/auth/
  - [ ] internal/task/
  - [ ] internal/session/
  - [ ] internal/llm/
  - [ ] internal/agent/
  - [ ] internal/http/

## 2. 数据库相关
- [ ] 实现数据库连接和初始化
- [ ] 创建必要的数据表结构

## 3. Auth 模块
- [ ] 实现用户注册和登录功能
- [ ] 完善 JWT 认证机制

## 4. Task 模块
- [ ] internal/task/repo.go
  - [ ] GetTaskWithSteps: 查询 tasks + task_steps
  - [ ] InsertTaskWithSteps: 事务插入 task & steps
  - [ ] ListTasks: 实现任务列表查询
- [ ] internal/task/service.go
  - [ ] CreateFromText: 实现从文本创建任务的完整逻辑
    - [ ] 构造 prompt 和 ChatRequest
    - [ ] 调用 llmClient.Chat
    - [ ] 解析 JSON -> Task + Steps
    - [ ] 调用 repo.InsertTaskWithSteps

## 5. Session 模块
- [ ] internal/session/repo.go
  - [ ] GetSession: 查询 sessions
  - [ ] CreateMessage: 插入 messages
  - [ ] ListRecentMessages: 按 created_at DESC LIMIT 查询最近消息

## 6. LLM 模块
- [ ] internal/llm/client.go
  - [ ] 完善 ChatRequest 结构，添加 tools/tool_choice 等字段
  - [ ] 按实际 LLM 服务响应结构定义 ChatResponse

## 7. Agent 模块
- [ ] 实现所有 Agent
  - [ ] PlannerAgent
  - [ ] SummarizerAgent
  - [ ] GlobalAgent
  - [ ] 完善 ExecutorAgent
    - [ ] 构造 messages + tools 调用 LLM
    - [ ] 处理 LLM 响应，生成 assistant 回复文本
    - [ ] 生成对任务的结构化 patch
- [ ] internal/agent/service.go
  - [ ] 开启事务应用 TaskPatches 更新 task & steps & dependencies
  - [ ] 实现写 assistant 消息功能

## 8. HTTP 模块
- [ ] internal/http/task_handler.go
  - [ ] 注入 user_llm_settings service
  - [ ] 添加 tasks 列表 / 详情 / patch 路由
  - [ ] 实现从 DB 根据 userID 查 LLMConfig
- [ ] internal/http/session_handler.go
  - [ ] 注入 user_llm_settings service
  - [ ] 实现从 DB 根据 userID 获取 LLMConfig
- [ ] internal/http/router.go
  - [ ] 初始化 planner, summarizer, global agent

## 9. 其他
- [ ] 实现 user_llm_settings service，用于管理用户的 LLM 配置
- [ ] 完善错误处理和日志记录
- [ ] 编写单元测试和集成测试
- [ ] 优化性能和安全性

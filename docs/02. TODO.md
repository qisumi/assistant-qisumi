# 后端开发 TODO 列表

## 1. 目录结构创建
- [x] 创建完整的目录结构
  - [x] cmd/server/main.go
  - [x] internal/config/
  - [x] internal/db/
  - [x] internal/auth/
  - [x] internal/task/
  - [x] internal/session/
  - [x] internal/llm/
  - [x] internal/agent/
  - [x] internal/http/

## 2. 数据库相关
- [x] 实现数据库连接和初始化
- [x] 创建必要的数据表结构

## 3. Auth 模块
- [x] 实现用户注册和登录功能
- [x] 完善 JWT 认证机制

## 4. Task 模块
- [x] internal/task/repo.go
  - [x] GetTaskWithSteps: 查询 tasks + task_steps
  - [x] InsertTaskWithSteps: 事务插入 task & steps
  - [x] ListTasks: 实现任务列表查询
- [x] internal/task/service.go
  - [x] CreateFromText: 实现从文本创建任务的完整逻辑
    - [x] 构造 prompt 和 ChatRequest
    - [x] 调用 llmClient.Chat
    - [x] 解析 JSON -> Task + Steps
    - [x] 调用 repo.InsertTaskWithSteps

## 5. Session 模块
- [x] internal/session/repo.go
  - [x] GetSession: 查询 sessions
  - [x] CreateMessage: 插入 messages
  - [x] ListRecentMessages: 按 created_at DESC LIMIT 查询最近消息

## 6. LLM 模块
- [x] internal/llm/client.go
  - [x] 完善 ChatRequest 结构，添加 tools/tool_choice 等字段
  - [x] 按实际 LLM 服务响应结构定义 ChatResponse

## 7. Agent 模块
- [x] 实现所有 Agent
  - [x] PlannerAgent
  - [x] SummarizerAgent
  - [x] GlobalAgent
  - [x] 完善 ExecutorAgent
    - [x] 构造 messages + tools 调用 LLM
    - [x] 处理 LLM 响应，生成 assistant 回复文本
    - [x] 生成对任务的结构化 patch
- [x] internal/agent/service.go
  - [x] 开启事务应用 TaskPatches 更新 task & steps & dependencies
  - [x] 实现写 assistant 消息功能

## 8. HTTP 模块
- [x] internal/http/task_handler.go
  - [x] 注入 user_llm_settings service
  - [x] 添加 tasks 列表 / 详情 / patch 路由
  - [x] 实现从 DB 根据 userID 查 LLMConfig
- [x] internal/http/session_handler.go
  - [x] 注入 user_llm_settings service
  - [x] 实现从 DB 根据 userID 获取 LLMConfig
- [x] internal/http/router.go
  - [x] 初始化 planner, summarizer, global agent

## 9. 其他
- [x] 实现 user_llm_settings service，用于管理用户的 LLM 配置
- [ ] 完善错误处理和日志记录
- [ ] 编写单元测试和集成测试
- [ ] 优化性能和安全性

version: '3.8'

services:
  # 统一服务（包含前后端）
  app:
    build:
      context: .
      dockerfile: Dockerfile.unified
    container_name: qisumi-app
    restart: unless-stopped
    ports:
      - "4569:4569"
    environment:
      # 数据库配置
      - DB_TYPE=sqlite
      - DB_FILE_PATH=/app/data/assistant.db

      # HTTP 服务配置
      - HTTP_HOST=0.0.0.0
      - HTTP_PORT=4569

      # JWT 配置
      - JWT_SECRET=${JWT_SECRET:-change-this-secret-in-production}
      - JWT_EXPIRE_HOUR=${JWT_EXPIRE_HOUR:-24}

      # API Key 加密配置
      - API_KEY_ENCRYPTION_KEY=${API_KEY_ENCRYPTION_KEY:-change-this-32byte-key-in-production}

      # 日志配置
      - LOG_LEVEL=${LOG_LEVEL:-info}

      # LLM 配置（可选，也可以在应用内配置）
      - LLM_API_KEY=${LLM_API_KEY:-}
      - LLM_MODEL_NAME=${LLM_MODEL_NAME:-qwen-plus}
      - LLM_API_BASE_URL=${LLM_API_BASE_URL:-https://dashscope.aliyuncs.com/compatible-mode/v1}
      - LLM_THINKING_TYPE=${LLM_THINKING_TYPE:-auto}
      - LLM_REASONING_EFFORT=${LLM_REASONING_EFFORT:-medium}
      - ASSISTANT_NAME=${ASSISTANT_NAME:-小奇}

    volumes:
      # 持久化数据库
      - qisumi-data:/app/data
      # 日志挂载
      - qisumi-logs:/app/logs
    networks:
      - qisumi-network
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:4569/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

volumes:
  # 数据持久化
  qisumi-data:
    driver: local
  qisumi-logs:
    driver: local

networks:
  qisumi-network:
    driver: bridge
